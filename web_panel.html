<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Manager Pro - Панель Управления</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-darker);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 15% 40%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 85% 70%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 10%, rgba(139, 92, 246, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header .logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .login-header .logo i {
            font-size: 32px;
            color: white;
        }

        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        input, textarea, select {
            width: 100%;
            padding: 16px 18px 16px 50px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid var(--border);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.9);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        input:focus ~ i {
            color: var(--primary);
        }

        textarea {
            padding: 16px 18px;
            resize: vertical;
            min-height: 120px;
        }

        select {
            cursor: pointer;
            padding-right: 45px;
        }

        .btn {
            width: 100%;
            padding: 16px 28px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-light);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .register-link {
            text-align: center;
            margin-top: 28px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .register-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .register-link a:hover {
            color: var(--secondary);
        }

        .dashboard {
            display: none;
        }

        .navbar {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 21px;
            font-weight: 700;
        }

        .navbar-brand .logo {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar-brand .logo i {
            color: white;
            font-size: 20px;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: var(--surface);
            border-radius: 14px;
            font-size: 14px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 15px;
        }

        .container {
            max-width: 1480px;
            margin: 0 auto;
            padding: 36px 28px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 36px;
            background: rgba(30, 41, 59, 0.8);
            padding: 10px;
            border-radius: 18px;
            overflow-x: auto;
        }

        .tab {
            padding: 13px 26px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            font-family: inherit;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tab:hover:not(.active) {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 32px;
            margin-bottom: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            color: var(--primary);
            font-size: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 36px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(16, 185, 129, 0.12) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 18px;
            padding: 28px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 16px 40px rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary);
        }

        .stat-change.down {
            color: var(--danger);
        }

        .account-list, .template-list, .history-list {
            display: grid;
            gap: 16px;
        }

        .account-item, .template-item, .history-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .account-item:hover, .template-item:hover, .history-item:hover {
            background: var(--surface-light);
            transform: translateX(4px);
        }

        .account-info, .template-info, .history-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .account-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .account-details h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .account-details p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }

        .status-inactive {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        .account-actions, .template-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-contacts {
            background: rgba(6, 182, 212, 0.2);
            color: var(--info);
        }

        .btn-edit {
            background: rgba(37, 99, 235, 0.2);
            color: var(--primary);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .btn-use {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .btn-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-close:hover {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .alert {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--secondary);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .alert-info {
            background: rgba(37, 99, 235, 0.2);
            border: 1px solid rgba(37, 99, 235, 0.3);
            color: var(--primary);
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-label {
            cursor: pointer;
        }

        .file-preview {
            margin-top: 16px;
            padding: 12px;
            background: var(--surface);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: nowrap;
            }

            .account-item, .template-item {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="logo"><i class="fas fa-robot"></i></div>
                <h1>Telegram Manager Pro</h1>
                <p>Управляйте рассылками профессионально</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Логин</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" placeholder="Введите логин" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" placeholder="Введите пароль" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Войти
                </button>
            </form>
            <div class="register-link">
                Нет аккаунта? <a href="#" onclick="showRegister()">Зарегистрироваться</a>
            </div>
            <div id="alertContainer"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <div class="navbar-brand">
                <div class="logo"><i class="fas fa-robot"></i></div>
                Telegram Manager Pro
            </div>
            <div class="navbar-actions">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="usernameDisplay"></span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Выйти
                </button>
            </div>
        </nav>
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">Дашборд</button>
                <button class="tab" onclick="switchTab('accounts')">Аккаунты</button>
                <button class="tab" onclick="switchTab('templates')">Шаблоны</button>
                <button class="tab" onclick="switchTab('broadcast')">Рассылка</button>
                <button class="tab" onclick="switchTab('instant')">Автоответ</button>
                <button class="tab" onclick="switchTab('history')">История</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Аккаунтов</div>
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-value" id="statAccounts">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> +2 за неделю</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Шаблонов</div>
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        </div>
                        <div class="stat-value" id="statTemplates">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> +5 за неделю</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Отправлено</div>
                            <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
                        </div>
                        <div class="stat-value" id="statSent">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> +150 за неделю</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-label">Успешно</div>
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="stat-value" id="statSuccess">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> 95% success rate</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Сообщения за неделю</h3>
                        <canvas id="messagesChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Типы чатов</h3>
                        <canvas id="chatsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Статус рассылок</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accountsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i>
                            Telegram Аккаунты
                        </h3>
                        <button class="btn btn-primary" onclick="showAddAccountModal()">
                            <i class="fas fa-plus"></i>
                            Добавить аккаунт
                        </button>
                    </div>
                    <div id="accountsList"></div>
                </div>
            </div>

            <!-- Templates Tab -->
            <div id="templatesTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-alt"></i>
                            Шаблоны сообщений
                        </h3>
                        <button class="btn btn-primary" onclick="showAddTemplateModal()">
                            <i class="fas fa-plus"></i>
                            Создать шаблон
                        </button>
                    </div>
                    <div id="templatesList"></div>
                </div>
            </div>

            <!-- Broadcast Tab -->
            <div id="broadcastTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-paper-plane"></i>
                            Рассылка сообщений
                        </h3>
                    </div>
                    <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                        <div class="form-group">
                            <label>Аккаунт для рассылки</label>
                            <select id="broadcastAccount" onchange="loadContactsForAccount()" required></select>
                        </div>
                        <div class="form-group">
                            <label>Текст сообщения</label>
                            <textarea id="broadcastText" placeholder="Введите текст..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Задержка (секунды)</label>
                            <input type="number" id="broadcastDelay" value="30" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Прикрепить файл (опционально)</label>
                            <div class="file-upload" onclick="document.getElementById('broadcastFile').click()">
                                <input type="file" id="broadcastFile" accept="image/*,video/*,.pdf,.doc,.docx" onchange="handleBroadcastFileUpload(event)">
                                <div class="file-upload-label">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--primary); margin-bottom: 12px;"></i>
                                    <p>Нажмите для загрузки файла</p>
                                </div>
                            </div>
                            <div id="broadcastFilePreview"></div>
                        </div>
                        <div id="contactsSection" class="hidden">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-address-book"></i>
                                    Выберите получателей
                                </h3>
                                <button type="button" class="btn btn-secondary" onclick="refreshContacts()">
                                    <i class="fas fa-sync-alt"></i>
                                    Обновить
                                </button>
                            </div>
                            <div class="search-bar">
                                <input type="text" id="contactsSearch" placeholder="Поиск контактов..." oninput="filterContacts()">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="select-all">
                                <input type="checkbox" id="selectAllContacts" onchange="toggleSelectAll()">
                                <label for="selectAllContacts">Выбрать все</label>
                            </div>
                            <div id="contactsList" class="contacts-list"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Начать рассылку
                        </button>
                    </form>
                </div>
            </div>

            <!-- Instant Tab -->
            <div id="instantTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt"></i>
                            Автоответ
                        </h3>
                    </div>
                    <form onsubmit="saveInstantSettings(event)">
                        <div class="form-group">
                            <label>Аккаунт</label>
                            <select id="instantAccount" required></select>
                        </div>
                        <div class="form-group">
                            <label>Шаблон для ответа</label>
                            <select id="instantTemplate" required></select>
                        </div>
                        <div class="form-group">
                            <label>Задержка (секунды)</label>
                            <input type="number" id="instantDelay" value="30" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="instantEnabled">
                                Включить автоответ
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Сохранить
                        </button>
                    </form>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i>
                            История Рассылок
                        </h3>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить Telegram Аккаунт</h3>
                <button class="btn-close" onclick="closeModal('addAccountModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalAlertContainer"></div>
            <form id="addAccountForm" onsubmit="handleAddAccount(event)">
                <div class="form-group">
                    <label>Номер телефона</label>
                    <input type="tel" id="accountPhone" placeholder="+79991234567" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Отправить код
                </button>
            </form>

            <form id="verifyCodeForm" class="hidden" onsubmit="handleVerifyCode(event)">
                <div class="form-group">
                    <label>Код из Telegram</label>
                    <input type="text" id="accountCode" placeholder="12345" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i>
                    Подтвердить
                </button>
            </form>

            <form id="verify2FAForm" class="hidden" onsubmit="handleVerify2FA(event)">
                <div class="form-group">
                    <label>2FA Пароль</label>
                    <input type="password" id="account2FA" placeholder="Ваш Cloud Password" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-key"></i>
                    Подтвердить
                </button>
            </form>
        </div>
    </div>

    <!-- Add Template Modal -->
    <div id="addTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Создать Шаблон</h3>
                <button class="btn-close" onclick="closeModal('addTemplateModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addTemplateForm" onsubmit="handleAddTemplate(event)">
                <div class="form-group">
                    <label>Название шаблона</label>
                    <input type="text" id="templateName" placeholder="Например: Приветствие" required>
                </div>

                <div class="form-group">
                    <label>Текст сообщения</label>
                    <textarea id="templateText" placeholder="Введите текст шаблона..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Прикрепить файл (опционально)</label>
                    <div class="file-upload" onclick="document.getElementById('templateFile').click()">
                        <input type="file" id="templateFile" accept="image/*,video/*,.pdf,.doc,.docx" onchange="handleTemplateFileUpload(event)">
                        <div class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--primary); margin-bottom: 12px;"></i>
                            <p>Нажмите для загрузки файла</p>
                        </div>
                    </div>
                    <div id="templateFilePreview"></div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Сохранить шаблон
                </button>
            </form>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div id="contactsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Контакты Аккаунта</h3>
                <button class="btn-close" onclick="closeModal('contactsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-bar">
                <input type="text" id="modalContactsSearch" placeholder="Поиск контактов..." oninput="filterModalContacts()">
                <i class="fas fa-search"></i>
            </div>
            <div id="modalContactsList" class="contacts-list"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentAccountPhone = null;
        let phoneCodeHash = null;
        let messagesChart, chatsChart, statusChart;
        let selectedContacts = new Set();
        let allContacts = [];

        // Alert Functions
        function showAlert(message, type = 'info', containerId = 'alertContainer') {
            const container = document.getElementById(containerId);
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddAccountModal() {
            document.getElementById('addAccountModal').classList.add('active');
            document.getElementById('addAccountForm').classList.remove('hidden');
            document.getElementById('verifyCodeForm').classList.add('hidden');
            document.getElementById('verify2FAForm').classList.add('hidden');
        }

        function showAddTemplateModal() {
            document.getElementById('addTemplateModal').classList.add('active');
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'dashboard') initCharts();
            if (tabName === 'accounts') loadAccounts();
            if (tabName === 'templates') loadTemplates();
            if (tabName === 'broadcast') loadAccountsForBroadcast();
            if (tabName === 'instant') {
                loadAccountsForSelect('instantAccount');
                loadTemplatesForSelect('instantTemplate');
            }
            if (tabName === 'history') loadHistory();
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Login failed');
                }
                const data = await response.json();
                localStorage.setItem('token', data.token);
                currentUser = {username};
                document.getElementById('usernameDisplay').textContent = username;
                document.getElementById('userAvatar').textContent = username[0].toUpperCase();

                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                loadDashboard();
                showAlert('Добро пожаловать!', 'success', 'alertContainer');
            } catch (error) {
                showAlert('Неверный логин или пароль: ' + error.message, 'error');
            }
        }

        function showRegister() {
            const username = prompt('Введите желаемый логин:');
            if (!username) return;

            const password = prompt('Введите пароль (минимум 6 символов):');
            if (!password || password.length < 6) {
                alert('Пароль должен содержать минимум 6 символов');
                return;
            }

            registerUser(username, password);
        }

        async function registerUser(username, password) {
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Signup failed');
                }
                showAlert('Регистрация успешна! Войдите в систему', 'success');
            } catch (error) {
                showAlert('Ошибка регистрации: ' + error.message, 'error');
            }
        }

        async function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            showAlert('Вы вышли из системы', 'info');
        }

        // Dashboard Loading
        async function loadDashboard() {
            loadStats();
            initCharts();
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                document.getElementById('statAccounts').textContent = data.accounts;
                document.getElementById('statTemplates').textContent = data.templates;
                document.getElementById('statSent').textContent = data.sent;
                document.getElementById('statSuccess').textContent = data.success;
            } catch (error) {
                showAlert('Ошибка загрузки stats: ' + error.message, 'error');
            }
        }

        async function loadAccounts() {
            const accountsList = document.getElementById('accountsList');
            try {
                const response = await fetch('/api/accounts', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load accounts');
                const data = await response.json();
                accountsList.innerHTML = data.accounts.map(acc => `
                    <div class="account-item">
                        <div class="account-info">
                            <div class="account-avatar">${acc.first_name[0]}</div>
                            <div class="account-details">
                                <h4>${acc.username}</h4>
                                <p>${acc.phone}</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="status-badge status-${acc.status}">${acc.status}</span>
                            <div class="account-actions">
                                <button class="btn-icon btn-contacts" onclick="showContactsForAccount('${acc.phone}')" title="Контакты">
                                    <i class="fas fa-address-book"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteAccount('${acc.phone}')" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                accountsList.innerHTML = '<p style="color: var(--danger); text-align: center;">Ошибка загрузки аккаунтов</p>';
            }
        }

        async function deleteAccount(phone) {
            if (!confirm('Удалить аккаунт?')) return;
            try {
                const response = await fetch(`/api/accounts/${phone}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to delete');
                showAlert('Аккаунт удалён', 'success');
                loadAccounts();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        async function loadAccountsForSelect(selectId) {
            const select = document.getElementById(selectId);
            try {
                const response = await fetch('/api/accounts', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load accounts');
                const data = await response.json();
                select.innerHTML = '<option value="">Выберите аккаунт</option>';
                data.accounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.phone;
                    option.textContent = `${acc.phone} (${acc.username})`;
                    select.appendChild(option);
                });
            } catch (error) {
                select.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }

        async function loadAccountsForBroadcast() {
            await loadAccountsForSelect('broadcastAccount');
        }

        async function showContactsForAccount(phone) {
            try {
                const response = await fetch(`/api/accounts/${phone}/contacts`, {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load contacts');
                const data = await response.json();
                allContacts = data.contacts;
                renderModalContacts();
                document.getElementById('contactsModal').classList.add('active');
            } catch (error) {
                showAlert('Ошибка загрузки контактов: ' + error.message, 'error');
            }
        }

        function renderModalContacts() {
            const container = document.getElementById('modalContactsList');
            container.innerHTML = allContacts.map(contact => `
                <div class="contact-item">
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <h4>${contact.name}</h4>
                        <p>${contact.username || 'Нет username'}</p>
                    </div>
                    <span class="contact-type type-${contact.type}">
                        ${contact.type === 'private' ? 'Личный' : contact.type === 'group' ? 'Группа' : 'Канал'}
                    </span>
                </div>
            `).join('');
        }

        function filterModalContacts() {
            const search = document.getElementById('modalContactsSearch').value.toLowerCase();
            const filtered = allContacts.filter(c =>
                c.name.toLowerCase().includes(search) ||
                c.username.toLowerCase().includes(search)
            );

            const container = document.getElementById('modalContactsList');
            container.innerHTML = filtered.map(contact => `
                <div class="contact-item">
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <h4>${contact.name}</h4>
                        <p>${contact.username || 'Нет username'}</p>
                    </div>
                    <span class="contact-type type-${contact.type}">
                        ${contact.type === 'private' ? 'Личный' : contact.type === 'group' ? 'Группа' : 'Канал'}
                    </span>
                </div>
            `).join('');
        }

        async function loadContactsForAccount() {
            const phone = document.getElementById('broadcastAccount').value;
            if (!phone) {
                document.getElementById('contactsSection').classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`/api/accounts/${phone}/contacts`, {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load contacts');
                const data = await response.json();
                allContacts = data.contacts;
                renderContacts();
                document.getElementById('contactsSection').classList.remove('hidden');
            } catch (error) {
                showAlert('Ошибка загрузки контактов: ' + error.message, 'error');
            }
        }

        function renderContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = allContacts.map(contact => `
                <div class="contact-item" onclick="toggleContact(${contact.id})">
                    <input type="checkbox" id="contact_${contact.id}" ${selectedContacts.has(contact.id) ? 'checked' : ''} onclick="event.stopPropagation()">
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <h4>${contact.name}</h4>
                        <p>${contact.username || 'Нет username'}</p>
                    </div>
                    <span class="contact-type type-${contact.type}">
                        ${contact.type === 'private' ? 'Личный' : contact.type === 'group' ? 'Группа' : 'Канал'}
                    </span>
                </div>
            `).join('');
        }

        function toggleContact(id) {
            const checkbox = document.getElementById(`contact_${id}`);
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                selectedContacts.add(id);
            } else {
                selectedContacts.delete(id);
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllContacts').checked;
            selectedContacts.clear();
            if (selectAll) {
                allContacts.forEach(c => selectedContacts.add(c.id));
            }
            renderContacts();
        }

        function filterContacts() {
            const search = document.getElementById('contactsSearch').value.toLowerCase();
            const filtered = allContacts.filter(c =>
                c.name.toLowerCase().includes(search) ||
                c.username.toLowerCase().includes(search)
            );

            const container = document.getElementById('contactsList');
            container.innerHTML = filtered.map(contact => `
                <div class="contact-item" onclick="toggleContact(${contact.id})">
                    <input type="checkbox" id="contact_${contact.id}" ${selectedContacts.has(contact.id) ? 'checked' : ''} onclick="event.stopPropagation()">
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <h4>${contact.name}</h4>
                        <p>${contact.username || 'Нет username'}</p>
                    </div>
                    <span class="contact-type type-${contact.type}">
                        ${contact.type === 'private' ? 'Личный' : contact.type === 'group' ? 'Группа' : 'Канал'}
                    </span>
                </div>
            `).join('');
        }

        async function refreshContacts() {
            showAlert('Обновление контактов...', 'info');
            await loadContactsForAccount();
            showAlert('Контакты обновлены!', 'success');
        }

        async function sendBroadcast(e) {
            e.preventDefault();
            const account_phone = document.getElementById('broadcastAccount').value;
            const text = document.getElementById('broadcastText').value;
            const delay_seconds = parseInt(document.getElementById('broadcastDelay').value);
            const file = document.getElementById('broadcastFile').files[0];
            const chat_ids = Array.from(selectedContacts);

            if (!account_phone || !text || chat_ids.length === 0) {
                showAlert('Заполните все поля и выберите контакты', 'error');
                return;
            }

            if (!confirm(`Отправить сообщение ${chat_ids.length} получателям?`)) return;

            try {
                const formData = new FormData();
                formData.append('account_phone', account_phone);
                formData.append('text', text);
                formData.append('delay_seconds', delay_seconds);
                formData.append('chat_ids', JSON.stringify(chat_ids));
                if (file) formData.append('file', file);

                const response = await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`},
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to broadcast');
                showAlert('Рассылка начата!', 'success');
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        async function handleAddAccount(e) {
            e.preventDefault();
            currentAccountPhone = document.getElementById('accountPhone').value;

            try {
                const response = await fetch('/api/auth/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({phone: currentAccountPhone})
                });
                if (!response.ok) throw new Error('Failed to send code');
                const data = await response.json();
                phoneCodeHash = data.phone_code_hash;
                showAlert('Код отправлен в Telegram', 'success', 'modalAlertContainer');
                document.getElementById('addAccountForm').classList.add('hidden');
                document.getElementById('verifyCodeForm').classList.remove('hidden');
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error', 'modalAlertContainer');
            }
        }

        async function handleVerifyCode(e) {
            e.preventDefault();
            const code = document.getElementById('accountCode').value;

            try {
                const response = await fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({code, phone_code_hash: phoneCodeHash})
                });
                const data = await response.json();
                if (!data.success) {
                    if (data.needs_password) {
                        document.getElementById('verifyCodeForm').classList.add('hidden');
                        document.getElementById('verify2FAForm').classList.remove('hidden');
                        return;
                    }
                    throw new Error(data.message || 'Invalid code');
                }
                showAlert('Аккаунт успешно добавлен!', 'success', 'modalAlertContainer');
                setTimeout(() => {
                    closeModal('addAccountModal');
                    loadAccounts();
                }, 2000);
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error', 'modalAlertContainer');
            }
        }

        async function handleVerify2FA(e) {
            e.preventDefault();
            const password = document.getElementById('account2FA').value;

            try {
                const response = await fetch('/api/auth/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({password})
                });
                if (!response.ok) throw new Error('Failed to verify 2FA');
                showAlert('Аккаунт успешно добавлен!', 'success', 'modalAlertContainer');
                setTimeout(() => {
                    closeModal('addAccountModal');
                    loadAccounts();
                }, 2000);
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error', 'modalAlertContainer');
            }
        }

        async function handleAddTemplate(e) {
            e.preventDefault();
            const name = document.getElementById('templateName').value;
            const text = document.getElementById('templateText').value;
            const file = document.getElementById('templateFile').files[0];

            try {
                const formData = new FormData();
                formData.append('name', name);
                formData.append('text', text);
                if (file) formData.append('file', file);

                const response = await fetch('/api/templates/create', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`},
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to create template');
                showAlert('Шаблон создан!', 'success');
                closeModal('addTemplateModal');
                loadTemplates();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        async function loadTemplates() {
            const templatesList = document.getElementById('templatesList');
            try {
                const response = await fetch('/api/templates', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load templates');
                const data = await response.json();
                templatesList.innerHTML = data.templates.map(tpl => `
                    <div class="template-item">
                        <div class="template-info">
                            <i class="fas fa-file-alt" style="font-size: 24px; color: var(--primary);"></i>
                            <div>
                                <h4>${tpl.name}</h4>
                                <p>${tpl.text.substring(0, 50)}...</p>
                            </div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-icon btn-delete" onclick="deleteTemplate('${tpl.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                templatesList.innerHTML = '<p style="color: var(--danger); text-align: center;">Ошибка загрузки шаблонов</p>';
            }
        }

        async function deleteTemplate(name) {
            if (!confirm('Удалить шаблон?')) return;
            try {
                const response = await fetch(`/api/templates/${name}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to delete');
                showAlert('Шаблон удалён', 'success');
                loadTemplates();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        async function loadTemplatesForSelect(selectId) {
            const select = document.getElementById(selectId);
            try {
                const response = await fetch('/api/templates', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load templates');
                const data = await response.json();
                select.innerHTML = '<option value="">Выберите шаблон</option>';
                data.templates.forEach(tpl => {
                    const option = document.createElement('option');
                    option.value = tpl.name;
                    option.textContent = tpl.name;
                    select.appendChild(option);
                });
            } catch (error) {
                select.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }

        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            try {
                const response = await fetch('/api/history', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                if (!response.ok) throw new Error('Failed to load history');
                const data = await response.json();
                historyList.innerHTML = data.history.map(entry => `
                    <div class="history-item">
                        <div class="history-info">
                            <i class="fas fa-history" style="font-size: 24px; color: var(--primary);"></i>
                            <div>
                                <h4>${entry.date}</h4>
                                <p>Аккаунт: ${entry.account_phone} | Успешно: ${entry.successful}/${entry.total}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                historyList.innerHTML = '<p style="color: var(--danger); text-align: center;">Ошибка загрузки истории</p>';
            }
        }

        function handleTemplateFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('templateFilePreview');
            preview.innerHTML = `
                <div class="file-preview">
                    <i class="fas fa-file" style="font-size: 24px; color: var(--primary);"></i>
                    <span>${file.name}</span>
                    <button type="button" class="btn-icon btn-delete" onclick="clearFilePreview('templateFilePreview', 'templateFile')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        function handleBroadcastFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('broadcastFilePreview');
            preview.innerHTML = `
                <div class="file-preview">
                    <i class="fas fa-file" style="font-size: 24px; color: var(--primary);"></i>
                    <span>${file.name}</span>
                    <button type="button" class="btn-icon btn-delete" onclick="clearFilePreview('broadcastFilePreview', 'broadcastFile')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        function clearFilePreview(previewId, inputId) {
            document.getElementById(previewId).innerHTML = '';
            document.getElementById(inputId).value = '';
        }

        async function saveInstantSettings(e) {
            e.preventDefault();
            const account_phone = document.getElementById('instantAccount').value;
            const template_name = document.getElementById('instantTemplate').value;
            const delay_seconds = parseInt(document.getElementById('instantDelay').value);
            const enabled = document.getElementById('instantEnabled').checked;

            try {
                const response = await fetch('/api/instant/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({account_phone, enabled, template_name, delay_seconds})
                });
                if (!response.ok) throw new Error('Failed to save');
                showAlert('Настройки сохранены!', 'success');
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }

        function initCharts() {
            if (messagesChart) messagesChart.destroy();
            if (chatsChart) chatsChart.destroy();
            if (statusChart) statusChart.destroy();

            const ctx1 = document.getElementById('messagesChart');
            messagesChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                    datasets: [{
                        label: 'Отправлено',
                        data: [65, 59, 80, 81, 56, 55, 40],
                        borderColor: var(--primary),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: var(--text-secondary) } },
                        x: { grid: { display: false }, ticks: { color: var(--text-secondary) } }
                    }
                }
            });

            const ctx2 = document.getElementById('chatsChart');
            chatsChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Личные', 'Группы', 'Каналы'],
                    datasets: [{
                        data: [45, 35, 20],
                        backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom', labels: { color: var(--text-secondary), padding: 15 } } }
                }
            });

            const ctx3 = document.getElementById('statusChart');
            statusChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['Успешно', 'Ошибка', 'В очереди'],
                    datasets: [{
                        data: [85, 10, 5],
                        backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)'],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: var(--text-secondary) } },
                        x: { grid: { display: false }, ticks: { color: var(--text-secondary) } }
                    }
                }
            });
        }

        // Check auth on load
        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch('/api/accounts', {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    if (response.ok) {
                        document.getElementById('usernameDisplay').textContent = 'User';  // Можно загрузить реальный username
                        document.getElementById('userAvatar').textContent = 'U';
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        loadDashboard();
                    } else {
                        localStorage.removeItem('token');
                    }
                } catch {
                    localStorage.removeItem('token');
                }
            }
        });
    </script>
</body>
</html>
